<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Group Wishlist</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="snow-container"></div>

<nav>
  <a href="Main.html">Home</a>
  <a href="profile.html">Profile</a>
  <a href="personalWishlist.html">Personal Wishlist</a>
</nav>

<div class="container">
  <h1>Your Group Wishlist</h1>
  <button id="joinGroupBtn">Join Group</button>
  <button id="addGroupItemBtn">Add Group Item</button>

  <ul id="groupWishlist">
    <!-- Wishlist items will be dynamically inserted here -->
  </ul>
</div>

<script src="https://cdn.jsdelivr.net/npm/web3@1.6.0/dist/web3.min.js"></script>
<script>
  let web3, accounts, contract;

  const contractAddress = '0xB7c7eB4A62F1938F6B588D37398db1D6A88EF233';
  const abi = [
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "item",
				"type": "string"
			}
		],
		"name": "addItem",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "address",
				"name": "member",
				"type": "address"
			}
		],
		"name": "GroupJoined",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "string",
				"name": "item",
				"type": "string"
			}
		],
		"name": "ItemAdded",
		"type": "event"
	},
	{
		"inputs": [],
		"name": "joinGroup",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getWishlist",
		"outputs": [
			{
				"internalType": "string[]",
				"name": "",
				"type": "string[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "groupMembers",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "owner",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "wishlist",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
];

  async function initWeb3() {
    if (window.ethereum) {
      try {
        web3 = new Web3(window.ethereum);
        await window.ethereum.request({ method: "eth_requestAccounts" });

        accounts = await web3.eth.getAccounts();
        if (accounts.length === 0) {
          alert('No accounts found. Please connect your MetaMask wallet.');
          return;
        }

        contract = new web3.eth.Contract(abi, contractAddress);

        // ✅ Привязываем кнопки к обработчикам событий после успешной инициализации Web3
        document.getElementById('joinGroupBtn').addEventListener('click', joinGroup);
        document.getElementById('addGroupItemBtn').addEventListener('click', addItem);

      } catch (error) {
        console.error('Error initializing Web3:', error);
        alert('Failed to initialize Web3. Please check your MetaMask connection.');
      }
    } else {
      alert('MetaMask is not installed. Please install it and reload the page.');
    }
  }

  async function joinGroup() {
    if (!contract) {
      alert('Contract is not initialized. Please reload the page.');
      return;
    }

    try {
      await contract.methods.joinGroup().send({ from: accounts[0] });
      alert('You have successfully joined the group!');
    } catch (error) {
      console.error('Error joining group:', error);
      alert('Error joining group.');
    }
  }

  async function addItem() {
    if (!contract) {
      alert('Contract is not initialized. Please reload the page.');
      return;
    }

    const item = prompt('Enter the item to add to the group wishlist:');
    if (item) {
      try {
        await contract.methods.addItem(item).send({ from: accounts[0] });
        alert('Item added to the wishlist!');
        updateWishlist();
      } catch (error) {
        console.error('Error adding item:', error);
        alert('Error adding item.');
      }
    }
  }

  async function updateWishlist() {
    if (!contract) {
      alert('Contract is not initialized. Please reload the page.');
      return;
    }

    try {
      const wishlist = await contract.methods.getWishlist().call();
      const wishlistElement = document.getElementById('groupWishlist');
      wishlistElement.innerHTML = '';
      wishlist.forEach(item => {
        const listItem = document.createElement('li');
        listItem.textContent = item;
        wishlistElement.appendChild(listItem);
      });
    } catch (error) {
      console.error('Error fetching wishlist:', error);
    }
  }

  window.addEventListener('load', async () => {
    await initWeb3();
    if (contract) {
      updateWishlist();
    }
  });
</script>


</body>
</html>
